# 朋友圈图片缓存功能需求文档

## 1. 功能概述
实现朋友圈大图的缓存功能，通过在应用沙盒目录中缓存图片原图，提高二次加载速度，优化用户体验。缓存采用一个月的有效期限制，超期自动清理。

## 2. 功能详细描述

### 2.1 基础功能
1. **图片缓存存储**
   - 仅缓存图片原图（大图）
   - 使用应用沙盒目录进行存储
   - 缓存文件按照图片URL的哈希值命名

2. **缓存策略**
   - 缓存有效期为一个月
   - 超过一个月的缓存文件自动清除
   - 基于文件创建时间判断缓存是否过期

3. **缓存查询与获取**
   - 快速查询图片是否在缓存中
   - 若缓存命中且未过期，直接从缓存加载图片
   - 若缓存过期或未命中，从网络加载并写入缓存

4. **缓存清理机制**
   - 应用启动时检查缓存文件时间
   - 自动清理超过一个月的缓存文件
   - 提供手动清理所有缓存的选项

### 2.2 性能优化
1. **存储优化**
   - 异步写入缓存，避免阻塞主线程
   - 使用高效的文件操作方式

2. **加载优化**
   - 异步读取缓存文件
   - 缓存文件读取失败时自动回退到网络加载

## 3. 技术实现要点

### 3.1 架构设计
1. **新增组件**
   - `ImageCacheManager`: 负责管理图片缓存的核心类
   - `ImageCacheStore`: 处理沙盒目录中的文件存储和读取
   - `CacheConfig`: 配置缓存参数，如过期时间
   - `CachedImage`: 支持缓存的图片加载组件

2. **与现有系统的集成**
   - 在`PreviewableImageView`中集成缓存功能
   - 更新`ImageItem`模型，添加缓存状态属性

### 3.2 关键实现
1. 使用 `FileManager` 进行缓存文件管理
2. 基于URL的SHA256哈希作为缓存文件名
3. 使用文件属性存储和检查缓存时间

## 4. 验收标准

### 4.1 功能验收
1. - [ ] 成功缓存大图到沙盒目录
2. - [ ] 缓存文件正确命名和存储
3. - [ ] 一个月后自动清理过期缓存
4. - [ ] 手动清理缓存功能正常

### 4.2 性能验收
1. - [ ] 缓存查询响应时间小于10ms
2. - [ ] 从缓存加载图片比网络加载快50%以上
3. - [ ] 异步缓存操作不影响主线程性能
4. - [ ] 缓存文件管理效率高，不影响应用启动时间

### 4.3 用户体验验收
1. - [ ] 二次加载图片速度明显提升
2. - [ ] 缓存机制运行稳定，无崩溃或卡顿
3. - [ ] 缓存清理不影响用户正常使用

## 5. 注意事项
1. 需要处理缓存文件损坏的情况
2. 确保缓存清理不影响用户正在查看的图片
3. 注意文件命名冲突的处理
4. 定期检查缓存目录大小，避免占用过多存储空间

## 6. 后续优化建议
1. 添加缓存预热机制，提前缓存热门图片
2. 实现缓存统计功能，收集使用数据
3. 优化缓存文件的压缩算法
4. 考虑增加缓存容量上限配置
5. 添加网络环境感知，在WiFi环境下主动缓存